services:
  api:
    build:
      context: .
      target: api
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=5000


  web:
    build:
      context: .
      target: web
    restart: unless-stopped
    depends_on:
      - api
    networks:
      - traefik_public
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.carinjurylaw.rule=Host(`${DOMAIN:-www.carinjurylaw.com}`) || Host(`${BARE_DOMAIN:-carinjurylaw.com}`)"
      - "traefik.http.routers.carinjurylaw.entrypoints=websecure"
      - "traefik.http.routers.carinjurylaw.tls=true"
      - "traefik.http.routers.carinjurylaw.tls.certresolver=myresolver"
      - "traefik.http.services.carinjurylaw.loadbalancer.server.port=80"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.routers.carinjurylaw.middlewares=redirect-to-https"

networks:
  traefik_public:
    external: true
